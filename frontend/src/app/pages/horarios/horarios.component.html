<mat-sidenav-container class="horarios-container">
  <mat-sidenav mode="side" opened class="sidenav">
    <mat-nav-list>
      <a mat-list-item routerLink="/admin">Dashboard</a>
      <a mat-list-item (click)="goToHome()">Início</a>
    </mat-nav-list>
  </mat-sidenav>

  <mat-sidenav-content>
    <mat-card class="horarios-card">
      <mat-card-content class="horarios-card-content">
        <!-- Cabeçalho: categoria à esquerda, botões à direita -->
        <div class="header-section">
          <h1 class="page-header">Horários - GRADUADOS</h1>
          <div class="admin__button-container">
            <button mat-mini-fab color="primary" class="admin__return-button" (click)="goToHome()" title="Início">
              <img src="assets/images/home.png" alt="Home" class="admin__return-icon" width="30" height="30" />
            </button>
            <button mat-mini-fab color="secondary" class="admin__logout-button" (click)="logout()" title="Sair">
              <img src="assets/images/logout.png" alt="Logout" class="admin__logout-icon" width="30" height="30" />
            </button>
          </div>
        </div>

        <!-- Aviso de agendamento -->
        <div class="info-panel" aria-label="Aviso de agendamento">
          <mat-icon>info</mat-icon>
          <span>Só é possível marcar uma vez a cada 15 dias.</span>
        </div>



      <div class="top-section">
        <div class="header-content-horizontal">
          <!-- Input + botões -->
          <div class="form-section" *ngIf="isAdmin">
            <div class="horario-actions">
              <mat-form-field appearance="fill" class="dia-field">
                <mat-label>Dia da Semana</mat-label>
                <mat-select [(ngModel)]="diaSelecionado" name="diaSelecionado">
                  <mat-option *ngFor="let dia of diasDaSemana; trackBy: trackByDia" [value]="dia">{{ dia | titlecase }}</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="fill" class="horario-field">
                <mat-label>Adicionar/Remover Horário (HH:MM)</mat-label>
                <input
                  matInput
                  [(ngModel)]="horarioPersonalizado"
                  (input)="formatarHorario($event)"
                  placeholder="Ex.: 08:15"
                  required
                  maxlength="5"
                  [ngClass]="{'invalid': !horarioValido}"
                />
                <mat-error *ngIf="!horarioValido">
                  Selecione um horário válido da lista.
                </mat-error>
              </mat-form-field>

              <button mat-raised-button color="primary" (click)="adicionarHorarioBase()"
                [disabled]="!horarioValido || !horarioPersonalizado">
                Adicionar
              </button>
              <button mat-raised-button color="warn" (click)="removerHorarioBase()"
                [disabled]="!horarioValido || !horarioPersonalizado">
                Remover
              </button>
              <button mat-raised-button color="accent" (click)="adicionarHorarioDia()"
                [disabled]="!horarioValido || !horarioPersonalizado">
                Disponibilizar horário
              </button>
            </div>
          </div>

          <!-- Legenda -->
          <div class="legenda-section">
            <div class="legenda">
              <div class="legenda-item"><span><b>Legenda:</b></span></div>
              <div class="legenda-item">
                <div class="circulo primary"></div><span>Disponível</span>
              </div>
              <div class="legenda-item">
                <div class="circulo warn"></div><span>Indisponível</span>
              </div>
              <div class="legenda-item">
                <div class="circulo accent"></div><span>Agendado</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabela de horários -->
      <table class="horarios">
        <thead class="horarios-header">
          <tr>
            <th *ngFor="let dia of diasDaSemana; trackBy: trackByDia" class="horarios-header-dia">
              <div class="header-container">
                <span>{{ dia | uppercase }}</span>
                <button *ngIf="isAdmin && !temAgendado(dia)" mat-icon-button
                        [color]="todosIndisponiveis(dia) ? 'primary' : 'warn'"
                        (click)="todosIndisponiveis(dia) ? disponibilizarDia(dia) : indisponibilizarDia(dia)"
                        [title]="todosIndisponiveis(dia) ? 'Disponibilizar ' + (dia | titlecase) : 'Indisponibilizar ' + (dia | titlecase)">
                  <mat-icon>{{ todosIndisponiveis(dia) ? 'check_circle' : 'block' }}</mat-icon>
                </button>
              </div>
            </th>
          </tr>
        </thead>
        <tbody class="horarios-body">
          <tr *ngFor="let horario of horariosBaseSemana; trackBy: trackByHorario">
            <td *ngFor="let dia of diasDaSemana; trackBy: trackByDia" class="horarios-coluna-dia">
              <div class="horarios-botao-container" [ngSwitch]="getHorarioStatus(dia, horario).status">
                <!-- ADMIN -->
                <ng-container *ngIf="isAdmin; else visualizacaoUsuario">
                  <button *ngSwitchCase="'DISPONIVEL'" class="botao-hora-disponivel" mat-raised-button color="primary"
                          (click)="indisponibilizarHorario(dia, horario, categoriaSelecionada)">
                    <b>{{ horario }}</b>
                  </button>

                  <button *ngSwitchCase="'INDISPONIVEL'" class="botao-hora-indisponivel" mat-raised-button disabled>
                          <b>{{ horario }}</b>
                  </button>

                  <ng-container *ngSwitchCase="'AGENDADO'">
                    <ng-container *ngIf="getAgendamentoParaDiaHora(dia, horario) as agendamento">
                        <button (click)="abrirModalAgendamento(agendamento)" mat-raised-button class="botao-hora-agendado">
                          <mat-icon>lock</mat-icon>
                          AGENDADO
                        </button>
                    </ng-container>
                  </ng-container>

                  <ng-container *ngSwitchDefault>
                    <button mat-raised-button class="botao-hora-adicionar" color="accent"
                            (click)="adicionarHorarioIndividual(dia, horario, categoriaSelecionada)">
                      Adicionar
                    </button>
                  </ng-container>
                </ng-container>

            <!-- USUÁRIO -->
            <ng-template #visualizacaoUsuario>
              <ng-container *ngIf="getAgendamentoParaDiaHora(dia, horario) as agendamento">
                <button mat-raised-button
                        class="botao-hora-agendado"
                        [disabled]="!isAgendamentoDoMilitarLogado(agendamento) || !isAgendamentoDesmarcavel(agendamento)"
                        (click)="handleClick(agendamento)">
                  <mat-icon>lock</mat-icon>
                  Agendado
                </button>
              </ng-container>

              <button *ngIf="!getAgendamentoParaDiaHora(dia, horario) && getHorarioStatus(dia, horario).status === 'DISPONIVEL'"
                      mat-raised-button
                      color="primary"
                      (click)="selecionarHorario(dia, horario)">
                {{ horario }}
              </button>

              <span *ngIf="!getAgendamentoParaDiaHora(dia, horario) && getHorarioStatus(dia, horario).status === 'INDISPONIVEL'"
                    class="horario-indisponivel">
                {{ horario }}
              </span>
            </ng-template>
              </div>
            </td>
          </tr>
          <tr *ngIf="!horariosBaseSemana.length">
            <td [colSpan]="diasDaSemana.length" class="no-horarios">
              Nenhum horário base disponível.
            </td>
          </tr>
        </tbody>
      </table>
    </mat-card-content>
  </mat-card>
  </mat-sidenav-content>
</mat-sidenav-container>
